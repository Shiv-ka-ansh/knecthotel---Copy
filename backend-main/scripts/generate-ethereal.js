const nodemailer = require('nodemailer');
const fs = require('fs');
const path = require('path');

async function createAndWrite() {
  const testAccount = await nodemailer.createTestAccount();

  const smtp = testAccount.smtp;

  const envPath = path.resolve(process.cwd(), '.env');
  let env = '';
  try {
    env = fs.readFileSync(envPath, 'utf8');
  } catch (e) {
    env = '';
  }

  // Remove existing email-related keys
  env = env
    .split(/\r?\n/)
    .filter(line => !/^(EMAIL_HOST|EMAIL_PORT|EMAIL_USER|EMAIL_PASS|ETHEREAL_)/.test(line))
    .join('\n');

  const additions = [
    `# Ethereal (test SMTP) - generated by scripts/generate-ethereal.js`,
    `ETHEREAL_HOST=${smtp.host}`,
    `ETHEREAL_PORT=${smtp.port}`,
    `ETHEREAL_SECURE=${smtp.secure}`,
    `ETHEREAL_USER=${testAccount.user}`,
    `ETHEREAL_PASS=${testAccount.pass}`,
    `# Also set generic EMAIL_* vars used by the app (overrides previous values)`,
    `EMAIL_HOST=${smtp.host}`,
    `EMAIL_PORT=${smtp.port}`,
    `EMAIL_USER=${testAccount.user}`,
    `EMAIL_PASS=${testAccount.pass}`,
  ].join('\n');

  const newEnv = env.trim() + '\n\n' + additions + '\n';
  fs.writeFileSync(envPath, newEnv, 'utf8');
  console.log('Ethereal test account created and .env updated.');
  console.log('Test SMTP credentials:');
  console.log(`User: ${testAccount.user}`);
  console.log(`Pass: ${testAccount.pass}`);
  console.log(`Host: ${smtp.host}`);
  console.log(`Port: ${smtp.port}`);
  console.log('You can view sent messages at https://ethereal.email/messages using the above credentials.');
}

createAndWrite().catch(err => {
  console.error('Failed to create ethereal account:', err);
  process.exit(1);
});
